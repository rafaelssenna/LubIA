// Prisma schema for LubIA - Sistema de Gestão de Oficinas

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Cliente da oficina
model Cliente {
  id        Int       @id @default(autoincrement())
  nome      String
  telefone  String
  email     String?
  cpf       String?   @unique
  endereco  String?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  veiculos  Veiculo[]

  @@map("clientes")
}

// Veículo do cliente
model Veiculo {
  id           Int      @id @default(autoincrement())
  placa        String   @unique
  marca        String
  modelo       String
  ano          Int?
  cor          String?
  kmAtual      Int?
  clienteId    Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  cliente      Cliente       @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  ordens       OrdemServico[]
  lembretes    Lembrete[]

  @@map("veiculos")
}

// Categoria de serviço
enum CategoriaServico {
  TROCA_OLEO
  FILTROS
  PNEUS
  REVISOES
  FREIOS
  SUSPENSAO
  ELETRICA
  AR_CONDICIONADO
  OUTROS
}

// Tipos de serviço oferecidos
model Servico {
  id          Int              @id @default(autoincrement())
  nome        String
  descricao   String?
  categoria   CategoriaServico @default(OUTROS)
  precoBase   Decimal          @db.Decimal(10, 2)
  duracaoMin  Int?             // duração estimada em minutos
  ativo       Boolean          @default(true)
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt

  itensOrdem  ItemOrdem[]

  @@map("servicos")
}

// Ordem de serviço
model OrdemServico {
  id          Int         @id @default(autoincrement())
  numero      String      @unique @default(cuid())
  veiculoId   Int
  status      StatusOS    @default(AGENDADO)
  dataAgendada DateTime?
  dataInicio   DateTime?
  dataConclusao DateTime?
  kmEntrada   Int?
  observacoes String?
  total       Decimal     @db.Decimal(10, 2) @default(0)
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt

  veiculo       Veiculo            @relation(fields: [veiculoId], references: [id], onDelete: Cascade)
  itens         ItemOrdem[]
  itensProduto  ItemOrdemProduto[]

  @@map("ordens_servico")
}

// Itens da ordem de serviço
model ItemOrdem {
  id            Int          @id @default(autoincrement())
  ordemId       Int
  servicoId     Int
  quantidade    Int          @default(1)
  precoUnitario Decimal      @db.Decimal(10, 2)
  desconto      Decimal      @db.Decimal(10, 2) @default(0)
  subtotal      Decimal      @db.Decimal(10, 2)

  ordem         OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)
  servico       Servico      @relation(fields: [servicoId], references: [id])

  @@map("itens_ordem")
}

// Lembretes de manutenção
model Lembrete {
  id            Int           @id @default(autoincrement())
  veiculoId     Int
  tipo          TipoLembrete
  dataLembrete  DateTime
  kmLembrete    Int?
  mensagem      String?
  enviado       Boolean       @default(false)
  dataEnvio     DateTime?
  createdAt     DateTime      @default(now())

  veiculo       Veiculo       @relation(fields: [veiculoId], references: [id], onDelete: Cascade)

  @@map("lembretes")
}

// Status da ordem de serviço
enum StatusOS {
  AGENDADO
  AGUARDANDO_PECAS
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
  ENTREGUE
}

// Tipo de lembrete
enum TipoLembrete {
  TROCA_OLEO
  REVISAO
  FILTROS
  PNEUS
  FREIOS
  OUTRO
}

// Categoria de produto no estoque
enum CategoriaProduto {
  OLEO_LUBRIFICANTE
  ADITIVO
  GRAXA
  FILTRO_OLEO
  FILTRO_AR
  FILTRO_AR_CONDICIONADO
  FILTRO_COMBUSTIVEL
  ACESSORIO
  OUTRO
}

// Unidade de medida
enum UnidadeMedida {
  LITRO
  UNIDADE
  KG
  METRO
}

// Produto no estoque
model Produto {
  id                Int              @id @default(autoincrement())
  codigo            String           @unique
  nome              String
  marca             String
  categoria         CategoriaProduto
  unidade           UnidadeMedida    @default(UNIDADE)
  quantidade        Decimal          @db.Decimal(10, 2) @default(0)
  estoqueMinimo     Decimal          @db.Decimal(10, 2) @default(0)
  precoCompra       Decimal          @db.Decimal(10, 2) @default(0)
  precoCompraAtual  Decimal          @db.Decimal(10, 2) @default(0)
  precoVenda        Decimal          @db.Decimal(10, 2) @default(0)
  precoGranel       Decimal?         @db.Decimal(10, 2)
  localizacao       String?
  ativo             Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  movimentacoes     MovimentacaoEstoque[]
  itensOrdem        ItemOrdemProduto[]

  @@map("produtos")
}

// Movimentação de estoque
model MovimentacaoEstoque {
  id           Int              @id @default(autoincrement())
  produtoId    Int
  tipo         TipoMovimentacao
  quantidade   Decimal          @db.Decimal(10, 2)
  precoUnit    Decimal?         @db.Decimal(10, 2)
  motivo       String?
  documento    String?
  createdAt    DateTime         @default(now())

  produto      Produto          @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@map("movimentacoes_estoque")
}

// Tipo de movimentação
enum TipoMovimentacao {
  ENTRADA
  SAIDA
  AJUSTE
  DEVOLUCAO
}

// Produtos usados em ordem de serviço
model ItemOrdemProduto {
  id            Int          @id @default(autoincrement())
  ordemId       Int
  produtoId     Int
  quantidade    Decimal      @db.Decimal(10, 2)
  precoUnitario Decimal      @db.Decimal(10, 2)
  desconto      Decimal      @db.Decimal(10, 2) @default(0)
  subtotal      Decimal      @db.Decimal(10, 2)

  ordem         OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)
  produto       Produto      @relation(fields: [produtoId], references: [id])

  @@map("itens_ordem_produto")
}

// Configurações do sistema (singleton)
model Configuracao {
  id                  Int      @id @default(1)
  // Dados da oficina
  nomeOficina         String?
  cnpj                String?
  telefone            String?
  endereco            String?
  // WhatsApp/UazAPI (token e instanceId criados automaticamente)
  uazapiInstanceId    String?
  uazapiToken         String?
  whatsappConnected   Boolean  @default(false)
  whatsappNumber      String?
  whatsappName        String?
  // Configurações gerais
  lembreteAntecedencia Int     @default(7) // dias antes para lembrar
  updatedAt           DateTime @updatedAt

  @@map("configuracoes")
}

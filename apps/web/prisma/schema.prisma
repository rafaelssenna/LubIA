// Prisma schema for LubIA - Sistema de Gestão de Oficinas
// Multi-tenant: cada Empresa tem seus dados isolados

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// MULTI-TENANCY: Empresa e Usuario
// =============================================

// Status da assinatura
enum SubscriptionStatus {
  TRIAL      // Período de teste (14 dias)
  ACTIVE     // Assinatura ativa
  PAST_DUE   // Pagamento falhou (período de graça)
  CANCELED   // Cancelada
  UNPAID     // Bloqueado - não pago
}

// Empresa (tenant) - cada oficina é uma empresa
model Empresa {
  id        Int      @id @default(autoincrement())
  nome      String
  slug      String   @unique
  cnpj      String?
  telefone  String?
  endereco  String?
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Campos de assinatura Stripe
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?            @unique
  subscriptionStatus   SubscriptionStatus @default(TRIAL)
  subscriptionEndsAt   DateTime?
  trialEndsAt          DateTime?

  // Relações com todos os models
  usuarios              Usuario[]
  clientes              Cliente[]
  veiculos              Veiculo[]
  servicos              Servico[]
  ordens                OrdemServico[]
  orcamentos            Orcamento[]
  lembretes             Lembrete[]
  produtos              Produto[]
  movimentacoes         MovimentacaoEstoque[]
  conversas             Conversa[]
  mensagens             Mensagem[]
  configuracao          Configuracao?
  filiais               Filial[]
  vendasRapidas         VendaRapida[]
  devolucoesVendaRapida DevolucaoVendaRapida[]
  pagamentos            Pagamento[]
  ideias                Ideia[]

  @@map("empresas")
}

// Níveis de acesso do usuário
enum RoleUsuario {
  ADMIN      // Acesso total, cria usuários, configura empresa
  GERENTE    // Relatórios, ordens, orçamentos, estoque, lembretes
  ATENDENTE  // Dashboard, O.S., WhatsApp, orçamentos
  VENDEDOR   // Apenas clientes, veículos, orçamentos, WhatsApp
}

// Usuario para autenticação
model Usuario {
  id           Int          @id @default(autoincrement())
  email        String       @unique
  senhaHash    String
  nome         String
  empresaId    Int
  role         RoleUsuario  @default(ATENDENTE)
  ativo        Boolean      @default(true)
  isInternal   Boolean      @default(false) // true = equipe interna, pode avaliar ideias
  isSuperAdmin Boolean      @default(false) // true = Helsen IA, acesso total a todas empresas
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt
  lastLoginAt  DateTime?

  empresa          Empresa          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  ideias           Ideia[]
  avaliacoesFeitas IdeiaAvaliacao[] @relation("AvaliacoesFeitas")
  passwordResetTokens PasswordResetToken[]

  @@index([empresaId])
  @@map("usuarios")
}

// =============================================
// CLIENTES E VEÍCULOS
// =============================================

// Cliente da oficina
model Cliente {
  id          Int       @id @default(autoincrement())
  empresaId   Int
  nome        String
  telefone    String
  email       String?
  cpf         String?
  endereco    String?
  observacoes String?   // Preferências e observações do cliente (JSON)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  empresa   Empresa    @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  veiculos  Veiculo[]
  conversas Conversa[]

  @@unique([cpf, empresaId])
  @@index([empresaId])
  @@map("clientes")
}

// Veículo (pode ou não ter cliente vinculado)
model Veiculo {
  id           Int      @id @default(autoincrement())
  empresaId    Int
  placa        String
  marca        String
  modelo       String
  ano          Int?
  cor          String?
  cilindrada   String?  // Ex: "1.0", "1.4", "2.0 Turbo"
  kmAtual      Int?
  kmInicial    Int?     // KM no momento do cadastro (base para calcular próxima troca)
  clienteId    Int?     // Opcional - veículo pode existir sem cliente (serviço avulso)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  empresa      Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente      Cliente?      @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  ordens       OrdemServico[]
  orcamentos   Orcamento[]
  lembretes    Lembrete[]

  @@unique([placa, empresaId])
  @@index([empresaId])
  @@index([clienteId])
  @@map("veiculos")
}

// =============================================
// SERVIÇOS
// =============================================

// Categoria de serviço
enum CategoriaServico {
  TROCA_OLEO
  FILTROS
  PNEUS
  REVISOES
  FREIOS
  SUSPENSAO
  ELETRICA
  AR_CONDICIONADO
  OUTROS
}

// Tipos de serviço oferecidos
model Servico {
  id            Int              @id @default(autoincrement())
  empresaId     Int
  nome          String
  descricao     String?
  categoria     CategoriaServico @default(OUTROS)
  precoBase     Decimal          @db.Decimal(10, 2)
  duracaoMin    Int?
  intervaloKm   Int?             // Intervalo em KM para próxima manutenção
  intervaloDias Int?             // Intervalo em dias para próxima manutenção
  ativo         Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  empresa        Empresa          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  itensOrdem     ItemOrdem[]
  itensOrcamento ItemOrcamento[]

  @@index([empresaId])
  @@map("servicos")
}

// =============================================
// ORDENS DE SERVIÇO
// =============================================

// Status da ordem de serviço
enum StatusOS {
  AGENDADO
  AGUARDANDO_PECAS
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
  ENTREGUE
}

// Forma de pagamento
enum FormaPagamento {
  DINHEIRO
  PIX
  CREDITO
  DEBITO
  CREDITO_PESSOAL
}

// Ordem de serviço
model OrdemServico {
  id             Int         @id @default(autoincrement())
  empresaId      Int
  numero         String      @default(cuid())
  veiculoId      Int
  status         StatusOS    @default(AGENDADO)
  dataAgendada   DateTime?
  dataInicio     DateTime?
  dataConclusao  DateTime?
  kmEntrada      Int?
  observacoes    String?
  total          Decimal        @db.Decimal(10, 2) @default(0)
  desconto       Decimal        @db.Decimal(5, 2) @default(0) // Percentual de desconto
  formaPagamento FormaPagamento?
  pago           Boolean        @default(true) // false = A Receber
  dataPagamentoPrevista DateTime? // Data prevista para pagamento (quando A Receber)
  dataPagamento  DateTime?       // Data do pagamento efetivo
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt

  empresa        Empresa            @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  veiculo        Veiculo            @relation(fields: [veiculoId], references: [id], onDelete: Cascade)
  itens          ItemOrdem[]
  itensProduto   ItemOrdemProduto[]
  servicosExtras ServicoExtra[]
  pagamentos     Pagamento[]

  @@unique([numero, empresaId])
  @@index([empresaId])
  @@index([pago]) // Index para buscar pendentes
  @@map("ordens_servico")
}

// Serviços extras (mão de obra, etc)
model ServicoExtra {
  id        Int          @id @default(autoincrement())
  ordemId   Int
  descricao String
  valor     Decimal      @db.Decimal(10, 2)

  ordem     OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)

  @@map("servicos_extras")
}

// Itens da ordem de serviço (serviços)
model ItemOrdem {
  id            Int          @id @default(autoincrement())
  ordemId       Int
  servicoId     Int
  quantidade    Int          @default(1)
  precoUnitario Decimal      @db.Decimal(10, 2)
  desconto      Decimal      @db.Decimal(10, 2) @default(0)
  subtotal      Decimal      @db.Decimal(10, 2)

  ordem         OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)
  servico       Servico      @relation(fields: [servicoId], references: [id])

  @@map("itens_ordem")
}

// =============================================
// LEMBRETES
// =============================================

// Tipo de lembrete
enum TipoLembrete {
  TROCA_OLEO
  REVISAO
  FILTROS
  PNEUS
  FREIOS
  OUTRO
}

// Lembretes de manutenção
model Lembrete {
  id            Int           @id @default(autoincrement())
  empresaId     Int
  veiculoId     Int
  tipo          TipoLembrete
  dataLembrete  DateTime
  kmLembrete    Int?
  mensagem      String?
  enviado       Boolean       @default(false)
  dataEnvio     DateTime?
  createdAt     DateTime      @default(now())

  empresa       Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  veiculo       Veiculo       @relation(fields: [veiculoId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@map("lembretes")
}

// =============================================
// ESTOQUE
// =============================================

// Categoria de produto no estoque
enum CategoriaProduto {
  OLEO_LUBRIFICANTE
  ADITIVO
  GRAXA
  FILTRO_OLEO
  FILTRO_AR
  FILTRO_AR_CONDICIONADO
  FILTRO_COMBUSTIVEL
  ACESSORIO
  OUTRO
}

// Unidade de medida
enum UnidadeMedida {
  LITRO
  UNIDADE
  KG
  METRO
}

// Filial/Fornecedor da empresa
model Filial {
  id        Int      @id @default(autoincrement())
  empresaId Int
  nome      String
  cnpj      String
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa   Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  produtos  Produto[]

  @@unique([cnpj, empresaId])
  @@index([empresaId])
  @@map("filiais")
}

// Produto no estoque
model Produto {
  id                Int              @id @default(autoincrement())
  empresaId         Int
  codigo            String
  nome              String
  marca             String
  categoria         CategoriaProduto
  unidade           UnidadeMedida    @default(UNIDADE)
  volumeUnidade     Decimal?         @db.Decimal(10, 2) // Volume por unidade (ex: 5 para galão de 5L)
  quantidade        Decimal          @db.Decimal(10, 2) @default(0)
  estoqueMinimo     Decimal          @db.Decimal(10, 2) @default(0)
  precoCompra       Decimal          @db.Decimal(10, 2) @default(0)
  precoCompraAtual  Decimal          @db.Decimal(10, 2) @default(0)
  precoVenda        Decimal          @db.Decimal(10, 2) @default(0)
  precoGranel       Decimal?         @db.Decimal(10, 2)
  localizacao       String?
  ncm               String?          // NCM - Nomenclatura Comum do Mercosul (8 dígitos)
  cfop              String?          // CFOP - Código Fiscal de Operações (4 dígitos)
  cnpjFornecedor    String?          // Campo legado - usar filialId
  filialId          Int?             // Filial/Fornecedor de onde veio o produto
  ativo             Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  empresa           Empresa              @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  filial            Filial?              @relation(fields: [filialId], references: [id])
  movimentacoes     MovimentacaoEstoque[]
  itensOrdem        ItemOrdemProduto[]
  itensOrcamento    ItemOrcamentoProduto[]
  itensVendaRapida  ItemVendaRapida[]
  itensDevolvidos   ItemDevolucaoVendaRapida[] @relation("ProdutoDevolvido")
  itensTrocados     ItemDevolucaoVendaRapida[] @relation("ProdutoTroca")
  itensTrocaMulti   ItemTrocaVendaRapida[]     @relation("ProdutoTrocaItem")

  @@unique([codigo, empresaId])
  @@index([empresaId])
  @@index([filialId])
  @@map("produtos")
}

// Tipo de movimentação
enum TipoMovimentacao {
  ENTRADA
  SAIDA
  AJUSTE
  DEVOLUCAO
}

// Movimentação de estoque
model MovimentacaoEstoque {
  id           Int              @id @default(autoincrement())
  empresaId    Int
  produtoId    Int
  tipo         TipoMovimentacao
  quantidade   Decimal          @db.Decimal(10, 2)
  precoUnit    Decimal?         @db.Decimal(10, 2)
  motivo       String?
  documento    String?
  createdAt    DateTime         @default(now())

  empresa      Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  produto      Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@map("movimentacoes_estoque")
}

// Produtos usados em ordem de serviço
model ItemOrdemProduto {
  id            Int          @id @default(autoincrement())
  ordemId       Int
  produtoId     Int
  quantidade    Decimal      @db.Decimal(10, 2)
  precoUnitario Decimal      @db.Decimal(10, 2)
  desconto      Decimal      @db.Decimal(10, 2) @default(0)
  subtotal      Decimal      @db.Decimal(10, 2)

  ordem         OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)
  produto       Produto      @relation(fields: [produtoId], references: [id])

  @@map("itens_ordem_produto")
}

// =============================================
// WHATSAPP
// =============================================

// Tipo de mensagem
enum TipoMensagem {
  TEXTO
  IMAGEM
  AUDIO
  VIDEO
  DOCUMENTO
  STICKER
  LOCALIZACAO
}

// Conversa do WhatsApp
model Conversa {
  id             Int        @id @default(autoincrement())
  empresaId      Int
  telefone       String
  nome           String?
  clienteId      Int?
  ultimaMensagem String?
  ultimaData     DateTime   @default(now())
  naoLidas       Int        @default(0)
  arquivada      Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  empresa        Empresa    @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente        Cliente?   @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  mensagens      Mensagem[]

  @@unique([telefone, empresaId])
  @@index([empresaId])
  @@map("conversas")
}

// Mensagem do WhatsApp
model Mensagem {
  id            Int          @id @default(autoincrement())
  empresaId     Int
  conversaId    Int
  messageId     String?
  tipo          TipoMensagem @default(TEXTO)
  conteudo      String
  enviada       Boolean
  lida          Boolean      @default(false)
  dataEnvio     DateTime     @default(now())
  metadata      String?
  createdAt     DateTime     @default(now())

  empresa       Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  conversa      Conversa @relation(fields: [conversaId], references: [id], onDelete: Cascade)

  @@unique([messageId, empresaId])
  @@index([empresaId])
  @@index([conversaId, dataEnvio])
  @@map("mensagens")
}

// =============================================
// CONFIGURAÇÕES (por empresa)
// =============================================

// Configurações do sistema (uma por empresa)
model Configuracao {
  id                   Int      @id @default(autoincrement())
  empresaId            Int      @unique
  // Dados da oficina
  nomeOficina          String?
  cnpj                 String?
  telefone             String?
  endereco             String?
  // WhatsApp/UazAPI
  uazapiInstanceId     String?
  uazapiToken          String?
  whatsappConnected    Boolean  @default(false)
  whatsappNumber       String?
  whatsappName         String?
  // Configurações do Chatbot LoopIA
  chatbotEnabled       Boolean  @default(true)
  chatbotNome          String?  @default("LoopIA")
  chatbotHorario       String?  @default("Segunda a Sexta 8h-18h, Sábado 8h-12h")
  chatbotServicos      String?  @default("troca de óleo, filtros, fluidos de freio, arrefecimento, direção hidráulica")
  chatbotBoasVindas    String?  @default("Olá! Sou a LoopIA, assistente virtual da oficina. Como posso ajudar?")
  // Configurações gerais
  lembreteAntecedencia Int      @default(7)
  updatedAt            DateTime @updatedAt

  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("configuracoes")
}

// =============================================
// ORÇAMENTOS
// =============================================

// Status do orçamento
enum StatusOrcamento {
  PENDENTE
  APROVADO
  RECUSADO
  EXPIRADO
  CONVERTIDO
}

// Orçamento para cliente (pode ser criado sem cliente/veículo cadastrado)
model Orcamento {
  id              Int              @id @default(autoincrement())
  empresaId       Int
  numero          String           // ORC-0001
  // Cliente (pode ser apenas nome/telefone sem cadastro)
  nomeCliente     String?
  telefoneCliente String?
  veiculoId       Int?             // Opcional - se o cliente já tiver veículo cadastrado
  status          StatusOrcamento  @default(PENDENTE)
  validade        DateTime?        // Opcional
  observacoes     String?
  total           Decimal          @db.Decimal(10, 2) @default(0)
  ordemServicoId  Int?             @unique // Quando convertido para O.S.
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  empresa        Empresa                  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  veiculo        Veiculo?                 @relation(fields: [veiculoId], references: [id], onDelete: Cascade)
  itens          ItemOrcamento[]
  itensProduto   ItemOrcamentoProduto[]
  servicosExtras ServicoExtraOrcamento[]

  @@unique([numero, empresaId])
  @@index([empresaId])
  @@map("orcamentos")
}

// Serviços extras do orçamento (mão de obra, etc)
model ServicoExtraOrcamento {
  id          Int       @id @default(autoincrement())
  orcamentoId Int
  descricao   String
  valor       Decimal   @db.Decimal(10, 2)

  orcamento   Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)

  @@map("servicos_extras_orcamento")
}

// Itens do orçamento (serviços)
model ItemOrcamento {
  id            Int       @id @default(autoincrement())
  orcamentoId   Int
  servicoId     Int
  quantidade    Int       @default(1)
  precoUnitario Decimal   @db.Decimal(10, 2)
  desconto      Decimal   @db.Decimal(10, 2) @default(0)
  subtotal      Decimal   @db.Decimal(10, 2)

  orcamento     Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  servico       Servico   @relation(fields: [servicoId], references: [id])

  @@map("itens_orcamento")
}

// Produtos do orçamento
model ItemOrcamentoProduto {
  id            Int       @id @default(autoincrement())
  orcamentoId   Int
  produtoId     Int
  quantidade    Decimal   @db.Decimal(10, 2)
  precoUnitario Decimal   @db.Decimal(10, 2)
  desconto      Decimal   @db.Decimal(10, 2) @default(0)
  subtotal      Decimal   @db.Decimal(10, 2)

  orcamento     Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  produto       Produto   @relation(fields: [produtoId], references: [id])

  @@map("itens_orcamento_produto")
}

// =============================================
// VENDAS RÁPIDAS (Balcão)
// =============================================

// Motivo da devolução
enum MotivoDevolucao {
  DEFEITO
  ARREPENDIMENTO
  OUTRO
}

// Tipo de devolução
enum TipoDevolucao {
  TROCA
  REEMBOLSO
}

// Venda rápida - sem necessidade de cliente cadastrado
model VendaRapida {
  id             Int             @id @default(autoincrement())
  empresaId      Int
  numero         String          // VR-0001
  nomeCliente    String?         // Opcional - apenas para identificação
  observacoes    String?
  total          Decimal         @db.Decimal(10, 2) @default(0)
  desconto       Decimal         @db.Decimal(5, 2) @default(0) // Percentual de desconto
  formaPagamento FormaPagamento?
  pago           Boolean         @default(true) // false = A Receber
  dataPagamentoPrevista DateTime? // Data prevista para pagamento (quando A Receber)
  dataPagamento  DateTime?       // Data do pagamento efetivo
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt

  empresa    Empresa                @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  itens      ItemVendaRapida[]
  devolucoes DevolucaoVendaRapida[]
  pagamentos Pagamento[]

  @@unique([numero, empresaId])
  @@index([empresaId])
  @@index([pago]) // Index para buscar pendentes
  @@map("vendas_rapidas")
}

// Itens da venda rápida
model ItemVendaRapida {
  id            Int         @id @default(autoincrement())
  vendaId       Int
  produtoId     Int
  quantidade    Decimal     @db.Decimal(10, 2)
  precoUnitario Decimal     @db.Decimal(10, 2)
  desconto      Decimal     @db.Decimal(10, 2) @default(0)
  subtotal      Decimal     @db.Decimal(10, 2)

  venda      VendaRapida                @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  produto    Produto                    @relation(fields: [produtoId], references: [id])
  devolucoes ItemDevolucaoVendaRapida[]

  @@map("itens_venda_rapida")
}

// =============================================
// PAGAMENTOS (múltiplas formas por transação)
// =============================================

// Pagamento - permite múltiplas formas de pagamento por venda/O.S.
model Pagamento {
  id                    Int             @id @default(autoincrement())
  empresaId             Int
  tipo                  FormaPagamento
  valor                 Decimal         @db.Decimal(10, 2)
  dataPagamento         DateTime?       // null = a receber (crédito pessoal)
  dataPagamentoPrevista DateTime?       // para crédito pessoal

  ordemServicoId        Int?
  vendaRapidaId         Int?

  createdAt             DateTime        @default(now())

  empresa               Empresa         @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  ordemServico          OrdemServico?   @relation(fields: [ordemServicoId], references: [id], onDelete: Cascade)
  vendaRapida           VendaRapida?    @relation(fields: [vendaRapidaId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@index([ordemServicoId])
  @@index([vendaRapidaId])
  @@map("pagamentos")
}

// =============================================
// DEVOLUÇÕES DE VENDA RÁPIDA
// =============================================

// Devolução de venda rápida
model DevolucaoVendaRapida {
  id             Int              @id @default(autoincrement())
  empresaId      Int
  vendaId        Int
  numero         String           // DEV-0001
  tipo           TipoDevolucao
  motivo         MotivoDevolucao
  motivoOutro    String?          // Quando motivo = OUTRO
  observacoes    String?
  valorTotal     Decimal          @db.Decimal(10, 2) @default(0)  // Valor dos produtos devolvidos
  valorTroca     Decimal          @db.Decimal(10, 2) @default(0)  // Valor dos produtos de troca
  diferencaTroca Decimal          @db.Decimal(10, 2) @default(0)  // Diferença: positivo = cliente paga, negativo = cliente recebe
  createdAt      DateTime         @default(now())

  empresa Empresa                    @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  venda   VendaRapida                @relation(fields: [vendaId], references: [id], onDelete: Cascade)
  itens   ItemDevolucaoVendaRapida[]

  @@unique([numero, empresaId])
  @@index([empresaId])
  @@index([vendaId])
  @@map("devolucoes_venda_rapida")
}

// Itens devolvidos
model ItemDevolucaoVendaRapida {
  id                  Int      @id @default(autoincrement())
  devolucaoId         Int
  itemVendaId         Int
  produtoId           Int
  quantidadeDevolvida Decimal  @db.Decimal(10, 2)
  valorUnitario       Decimal  @db.Decimal(10, 2)
  subtotal            Decimal  @db.Decimal(10, 2)
  produtoTrocaId      Int?     // Para TROCA: produto substituto
  quantidadeTroca     Decimal? @db.Decimal(10, 2)
  precoTroca          Decimal? @db.Decimal(10, 2) // Preço unitário do produto de troca

  devolucao    DevolucaoVendaRapida @relation(fields: [devolucaoId], references: [id], onDelete: Cascade)
  itemVenda    ItemVendaRapida      @relation(fields: [itemVendaId], references: [id])
  produto      Produto              @relation("ProdutoDevolvido", fields: [produtoId], references: [id])
  produtoTroca Produto?             @relation("ProdutoTroca", fields: [produtoTrocaId], references: [id])
  itensTroca   ItemTrocaVendaRapida[]

  @@map("itens_devolucao_venda_rapida")
}

// Itens de troca (múltiplos produtos por item devolvido)
model ItemTrocaVendaRapida {
  id              Int     @id @default(autoincrement())
  itemDevolucaoId Int
  produtoTrocaId  Int
  quantidadeTroca Decimal @db.Decimal(10, 2)
  precoTroca      Decimal @db.Decimal(10, 2)

  itemDevolucao ItemDevolucaoVendaRapida @relation(fields: [itemDevolucaoId], references: [id], onDelete: Cascade)
  produtoTroca  Produto                  @relation("ProdutoTrocaItem", fields: [produtoTrocaId], references: [id])

  @@map("itens_troca_venda_rapida")
}

// =============================================
// IDEÁRIO (Sistema de Sugestões)
// =============================================

// Categoria da ideia
enum CategoriaIdeia {
  FUNCIONALIDADE
  MELHORIA
  CORRECAO
  INTEGRACAO
  INTERFACE
  OUTRO
}

// Status da ideia
enum StatusIdeia {
  SUGERIDA
  EM_AVALIACAO
  APROVADA
  EM_DESENVOLVIMENTO
  IMPLEMENTADA
  ARQUIVADA
}

// Impacto esperado da ideia
enum ImpactoIdeia {
  BAIXO
  MEDIO
  ALTO
  CRITICO
}

// Ideia/Sugestão do usuário
model Ideia {
  id              Int            @id @default(autoincrement())
  empresaId       Int
  usuarioId       Int

  titulo          String         @db.VarChar(200)
  descricao       String         @db.Text
  categoria       CategoriaIdeia
  impacto         ImpactoIdeia   @default(MEDIO)
  status          StatusIdeia    @default(SUGERIDA)

  // Avaliação interna (média das notas)
  notaMedia       Decimal?       @db.Decimal(2, 1)
  totalAvaliacoes Int            @default(0)

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  empresa         Empresa        @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  usuario         Usuario        @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  avaliacoes      IdeiaAvaliacao[]

  @@index([empresaId])
  @@index([usuarioId])
  @@index([status])
  @@map("ideias")
}

// Avaliação de ideia pela equipe interna
model IdeiaAvaliacao {
  id          Int      @id @default(autoincrement())
  ideiaId     Int
  avaliadorId Int
  nota        Int      // 1 a 5 estrelas
  comentario  String?  @db.Text
  createdAt   DateTime @default(now())

  ideia       Ideia    @relation(fields: [ideiaId], references: [id], onDelete: Cascade)
  avaliador   Usuario  @relation("AvaliacoesFeitas", fields: [avaliadorId], references: [id], onDelete: Cascade)

  @@unique([ideiaId, avaliadorId]) // cada avaliador só avalia uma vez por ideia
  @@index([ideiaId])
  @@map("ideias_avaliacoes")
}

// =============================================
// RESET DE SENHA
// =============================================

// Token para recuperação de senha
model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  usuarioId Int
  expiresAt DateTime
  usedAt    DateTime?
  createdAt DateTime @default(now())

  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)

  @@index([usuarioId])
  @@map("password_reset_tokens")
}

// Prisma schema for LubIA - Sistema de Gestão de Oficinas
// Multi-tenant: cada Empresa tem seus dados isolados

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// =============================================
// MULTI-TENANCY: Empresa e Usuario
// =============================================

// Empresa (tenant) - cada oficina é uma empresa
model Empresa {
  id        Int      @id @default(autoincrement())
  nome      String
  slug      String   @unique
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relações com todos os models
  usuarios      Usuario[]
  clientes      Cliente[]
  veiculos      Veiculo[]
  servicos      Servico[]
  ordens        OrdemServico[]
  orcamentos    Orcamento[]
  lembretes     Lembrete[]
  produtos      Produto[]
  movimentacoes MovimentacaoEstoque[]
  conversas     Conversa[]
  mensagens     Mensagem[]
  configuracao  Configuracao?
  filiais       Filial[]

  @@map("empresas")
}

// Usuario para autenticação
model Usuario {
  id          Int       @id @default(autoincrement())
  email       String    @unique
  senhaHash   String
  nome        String
  empresaId   Int
  ativo       Boolean   @default(true)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  lastLoginAt DateTime?

  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@map("usuarios")
}

// =============================================
// CLIENTES E VEÍCULOS
// =============================================

// Cliente da oficina
model Cliente {
  id          Int       @id @default(autoincrement())
  empresaId   Int
  nome        String
  telefone    String
  email       String?
  cpf         String?
  endereco    String?
  observacoes String?   // Preferências e observações do cliente (JSON)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  empresa   Empresa    @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  veiculos  Veiculo[]
  conversas Conversa[]

  @@unique([cpf, empresaId])
  @@index([empresaId])
  @@map("clientes")
}

// Veículo do cliente
model Veiculo {
  id           Int      @id @default(autoincrement())
  empresaId    Int
  placa        String
  marca        String
  modelo       String
  ano          Int?
  cor          String?
  kmAtual      Int?
  clienteId    Int
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  empresa      Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente      Cliente       @relation(fields: [clienteId], references: [id], onDelete: Cascade)
  ordens       OrdemServico[]
  orcamentos   Orcamento[]
  lembretes    Lembrete[]

  @@unique([placa, empresaId])
  @@index([empresaId])
  @@map("veiculos")
}

// =============================================
// SERVIÇOS
// =============================================

// Categoria de serviço
enum CategoriaServico {
  TROCA_OLEO
  FILTROS
  PNEUS
  REVISOES
  FREIOS
  SUSPENSAO
  ELETRICA
  AR_CONDICIONADO
  OUTROS
}

// Tipos de serviço oferecidos
model Servico {
  id            Int              @id @default(autoincrement())
  empresaId     Int
  nome          String
  descricao     String?
  categoria     CategoriaServico @default(OUTROS)
  precoBase     Decimal          @db.Decimal(10, 2)
  duracaoMin    Int?
  intervaloKm   Int?             // Intervalo em KM para próxima manutenção
  intervaloDias Int?             // Intervalo em dias para próxima manutenção
  ativo         Boolean          @default(true)
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  empresa        Empresa          @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  itensOrdem     ItemOrdem[]
  itensOrcamento ItemOrcamento[]

  @@index([empresaId])
  @@map("servicos")
}

// =============================================
// ORDENS DE SERVIÇO
// =============================================

// Status da ordem de serviço
enum StatusOS {
  AGENDADO
  AGUARDANDO_PECAS
  EM_ANDAMENTO
  CONCLUIDO
  CANCELADO
  ENTREGUE
}

// Ordem de serviço
model OrdemServico {
  id             Int         @id @default(autoincrement())
  empresaId      Int
  numero         String      @default(cuid())
  veiculoId      Int
  status         StatusOS    @default(AGENDADO)
  dataAgendada   DateTime?
  dataInicio     DateTime?
  dataConclusao  DateTime?
  kmEntrada      Int?
  observacoes    String?
  total          Decimal     @db.Decimal(10, 2) @default(0)
  createdAt      DateTime    @default(now())
  updatedAt      DateTime    @updatedAt

  empresa        Empresa            @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  veiculo        Veiculo            @relation(fields: [veiculoId], references: [id], onDelete: Cascade)
  itens          ItemOrdem[]
  itensProduto   ItemOrdemProduto[]
  servicosExtras ServicoExtra[]

  @@unique([numero, empresaId])
  @@index([empresaId])
  @@map("ordens_servico")
}

// Serviços extras (mão de obra, etc)
model ServicoExtra {
  id        Int          @id @default(autoincrement())
  ordemId   Int
  descricao String
  valor     Decimal      @db.Decimal(10, 2)

  ordem     OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)

  @@map("servicos_extras")
}

// Itens da ordem de serviço (serviços)
model ItemOrdem {
  id            Int          @id @default(autoincrement())
  ordemId       Int
  servicoId     Int
  quantidade    Int          @default(1)
  precoUnitario Decimal      @db.Decimal(10, 2)
  desconto      Decimal      @db.Decimal(10, 2) @default(0)
  subtotal      Decimal      @db.Decimal(10, 2)

  ordem         OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)
  servico       Servico      @relation(fields: [servicoId], references: [id])

  @@map("itens_ordem")
}

// =============================================
// LEMBRETES
// =============================================

// Tipo de lembrete
enum TipoLembrete {
  TROCA_OLEO
  REVISAO
  FILTROS
  PNEUS
  FREIOS
  OUTRO
}

// Lembretes de manutenção
model Lembrete {
  id            Int           @id @default(autoincrement())
  empresaId     Int
  veiculoId     Int
  tipo          TipoLembrete
  dataLembrete  DateTime
  kmLembrete    Int?
  mensagem      String?
  enviado       Boolean       @default(false)
  dataEnvio     DateTime?
  createdAt     DateTime      @default(now())

  empresa       Empresa       @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  veiculo       Veiculo       @relation(fields: [veiculoId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@map("lembretes")
}

// =============================================
// ESTOQUE
// =============================================

// Categoria de produto no estoque
enum CategoriaProduto {
  OLEO_LUBRIFICANTE
  ADITIVO
  GRAXA
  FILTRO_OLEO
  FILTRO_AR
  FILTRO_AR_CONDICIONADO
  FILTRO_COMBUSTIVEL
  ACESSORIO
  OUTRO
}

// Unidade de medida
enum UnidadeMedida {
  LITRO
  UNIDADE
  KG
  METRO
}

// Filial/Fornecedor da empresa
model Filial {
  id        Int      @id @default(autoincrement())
  empresaId Int
  nome      String
  cnpj      String
  ativo     Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  empresa   Empresa   @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  produtos  Produto[]

  @@unique([cnpj, empresaId])
  @@index([empresaId])
  @@map("filiais")
}

// Produto no estoque
model Produto {
  id                Int              @id @default(autoincrement())
  empresaId         Int
  codigo            String
  nome              String
  marca             String
  categoria         CategoriaProduto
  unidade           UnidadeMedida    @default(UNIDADE)
  quantidade        Decimal          @db.Decimal(10, 2) @default(0)
  estoqueMinimo     Decimal          @db.Decimal(10, 2) @default(0)
  precoCompra       Decimal          @db.Decimal(10, 2) @default(0)
  precoCompraAtual  Decimal          @db.Decimal(10, 2) @default(0)
  precoVenda        Decimal          @db.Decimal(10, 2) @default(0)
  precoGranel       Decimal?         @db.Decimal(10, 2)
  localizacao       String?
  cnpjFornecedor    String?          // Campo legado - usar filialId
  filialId          Int?             // Filial/Fornecedor de onde veio o produto
  ativo             Boolean          @default(true)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  empresa           Empresa              @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  filial            Filial?              @relation(fields: [filialId], references: [id])
  movimentacoes     MovimentacaoEstoque[]
  itensOrdem        ItemOrdemProduto[]
  itensOrcamento    ItemOrcamentoProduto[]

  @@unique([codigo, empresaId])
  @@index([empresaId])
  @@index([filialId])
  @@map("produtos")
}

// Tipo de movimentação
enum TipoMovimentacao {
  ENTRADA
  SAIDA
  AJUSTE
  DEVOLUCAO
}

// Movimentação de estoque
model MovimentacaoEstoque {
  id           Int              @id @default(autoincrement())
  empresaId    Int
  produtoId    Int
  tipo         TipoMovimentacao
  quantidade   Decimal          @db.Decimal(10, 2)
  precoUnit    Decimal?         @db.Decimal(10, 2)
  motivo       String?
  documento    String?
  createdAt    DateTime         @default(now())

  empresa      Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  produto      Produto @relation(fields: [produtoId], references: [id], onDelete: Cascade)

  @@index([empresaId])
  @@map("movimentacoes_estoque")
}

// Produtos usados em ordem de serviço
model ItemOrdemProduto {
  id            Int          @id @default(autoincrement())
  ordemId       Int
  produtoId     Int
  quantidade    Decimal      @db.Decimal(10, 2)
  precoUnitario Decimal      @db.Decimal(10, 2)
  desconto      Decimal      @db.Decimal(10, 2) @default(0)
  subtotal      Decimal      @db.Decimal(10, 2)

  ordem         OrdemServico @relation(fields: [ordemId], references: [id], onDelete: Cascade)
  produto       Produto      @relation(fields: [produtoId], references: [id])

  @@map("itens_ordem_produto")
}

// =============================================
// WHATSAPP
// =============================================

// Tipo de mensagem
enum TipoMensagem {
  TEXTO
  IMAGEM
  AUDIO
  VIDEO
  DOCUMENTO
  STICKER
  LOCALIZACAO
}

// Conversa do WhatsApp
model Conversa {
  id             Int        @id @default(autoincrement())
  empresaId      Int
  telefone       String
  nome           String?
  clienteId      Int?
  ultimaMensagem String?
  ultimaData     DateTime   @default(now())
  naoLidas       Int        @default(0)
  arquivada      Boolean    @default(false)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  empresa        Empresa    @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  cliente        Cliente?   @relation(fields: [clienteId], references: [id], onDelete: SetNull)
  mensagens      Mensagem[]

  @@unique([telefone, empresaId])
  @@index([empresaId])
  @@map("conversas")
}

// Mensagem do WhatsApp
model Mensagem {
  id            Int          @id @default(autoincrement())
  empresaId     Int
  conversaId    Int
  messageId     String?
  tipo          TipoMensagem @default(TEXTO)
  conteudo      String
  enviada       Boolean
  lida          Boolean      @default(false)
  dataEnvio     DateTime     @default(now())
  metadata      String?
  createdAt     DateTime     @default(now())

  empresa       Empresa  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  conversa      Conversa @relation(fields: [conversaId], references: [id], onDelete: Cascade)

  @@unique([messageId, empresaId])
  @@index([empresaId])
  @@index([conversaId, dataEnvio])
  @@map("mensagens")
}

// =============================================
// CONFIGURAÇÕES (por empresa)
// =============================================

// Configurações do sistema (uma por empresa)
model Configuracao {
  id                   Int      @id @default(autoincrement())
  empresaId            Int      @unique
  // Dados da oficina
  nomeOficina          String?
  cnpj                 String?
  telefone             String?
  endereco             String?
  // WhatsApp/UazAPI
  uazapiInstanceId     String?
  uazapiToken          String?
  whatsappConnected    Boolean  @default(false)
  whatsappNumber       String?
  whatsappName         String?
  // Configurações do Chatbot LoopIA
  chatbotEnabled       Boolean  @default(true)
  chatbotNome          String?  @default("LoopIA")
  chatbotHorario       String?  @default("Segunda a Sexta 8h-18h, Sábado 8h-12h")
  chatbotServicos      String?  @default("troca de óleo, filtros, fluidos de freio, arrefecimento, direção hidráulica")
  chatbotBoasVindas    String?  @default("Olá! Sou a LoopIA, assistente virtual da oficina. Como posso ajudar?")
  // Configurações gerais
  lembreteAntecedencia Int      @default(7)
  updatedAt            DateTime @updatedAt

  empresa Empresa @relation(fields: [empresaId], references: [id], onDelete: Cascade)

  @@map("configuracoes")
}

// =============================================
// ORÇAMENTOS
// =============================================

// Status do orçamento
enum StatusOrcamento {
  PENDENTE
  APROVADO
  RECUSADO
  EXPIRADO
  CONVERTIDO
}

// Orçamento para cliente
model Orcamento {
  id             Int              @id @default(autoincrement())
  empresaId      Int
  numero         String           // ORC-0001
  veiculoId      Int
  status         StatusOrcamento  @default(PENDENTE)
  validade       DateTime         // Data de validade do orçamento
  observacoes    String?
  total          Decimal          @db.Decimal(10, 2) @default(0)
  ordemServicoId Int?             @unique // Quando convertido para O.S.
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt

  empresa        Empresa                  @relation(fields: [empresaId], references: [id], onDelete: Cascade)
  veiculo        Veiculo                  @relation(fields: [veiculoId], references: [id], onDelete: Cascade)
  itens          ItemOrcamento[]
  itensProduto   ItemOrcamentoProduto[]
  servicosExtras ServicoExtraOrcamento[]

  @@unique([numero, empresaId])
  @@index([empresaId])
  @@map("orcamentos")
}

// Serviços extras do orçamento (mão de obra, etc)
model ServicoExtraOrcamento {
  id          Int       @id @default(autoincrement())
  orcamentoId Int
  descricao   String
  valor       Decimal   @db.Decimal(10, 2)

  orcamento   Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)

  @@map("servicos_extras_orcamento")
}

// Itens do orçamento (serviços)
model ItemOrcamento {
  id            Int       @id @default(autoincrement())
  orcamentoId   Int
  servicoId     Int
  quantidade    Int       @default(1)
  precoUnitario Decimal   @db.Decimal(10, 2)
  desconto      Decimal   @db.Decimal(10, 2) @default(0)
  subtotal      Decimal   @db.Decimal(10, 2)

  orcamento     Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  servico       Servico   @relation(fields: [servicoId], references: [id])

  @@map("itens_orcamento")
}

// Produtos do orçamento
model ItemOrcamentoProduto {
  id            Int       @id @default(autoincrement())
  orcamentoId   Int
  produtoId     Int
  quantidade    Decimal   @db.Decimal(10, 2)
  precoUnitario Decimal   @db.Decimal(10, 2)
  desconto      Decimal   @db.Decimal(10, 2) @default(0)
  subtotal      Decimal   @db.Decimal(10, 2)

  orcamento     Orcamento @relation(fields: [orcamentoId], references: [id], onDelete: Cascade)
  produto       Produto   @relation(fields: [produtoId], references: [id])

  @@map("itens_orcamento_produto")
}
